{"version":3,"file":"map-viewer.js","sourceRoot":"","sources":["src/map-viewer.ts"],"names":[],"mappings":"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","sourcesContent":["import {LitElement, html} from 'lit';\r\nimport { customElement, property } from 'lit/decorators.js';\r\n\r\nimport './composants/DataLoader.js';\r\n\r\nimport {createCesiumViewer, zoomToDataSource} from \"./cesium/cesiumHelpers\";\r\nimport {addData, addTileset} from './cesium/dataLoader';\r\n\r\nimport {styles} from \"./styles/styles\";\r\nimport {Cesium3DTileset, DataSource, Viewer} from \"cesium\";\r\n\r\nimport apiService from \"./api/apiService\";\r\n\r\nimport {legend} from \"./cesium/dataLoader\";\r\n\r\n\r\n@customElement('map-viewer')\r\nexport class MapViewer extends LitElement{\r\n    static override styles = styles;\r\n\r\n    @property({type: Boolean})\r\n    loading = true;\r\n\r\n    @property({ type: String, attribute: 'cesium-base-url' })\r\n    cesiumBaseURL = '';\r\n\r\n    @property({ type: String, attribute: 'ion-token' })\r\n    ionToken = '';\r\n\r\n    @property({ type: String, attribute: 'data-terrain' }) // New\r\n    dataTerrain = '';\r\n\r\n    @property({ type: Array, attribute: 'data-tileset', converter: {\r\n            fromAttribute: (value: any) => {\r\n                try {\r\n                    return new Map(JSON.parse(value));\r\n                } catch {\r\n                    return new Map();\r\n                }\r\n            },\r\n        }})\r\n    tilesetUrl:  Map<string, { url: string; icon: string | undefined, description: string | undefined, tileset?: Cesium3DTileset  }> = new Map();\r\n\r\n\r\n    @property({ type: Object, converter: {\r\n            fromAttribute: (value:any) => {\r\n                try {\r\n                    return new Map(JSON.parse(value));\r\n                } catch {\r\n                    return new Map();\r\n                }\r\n            },\r\n        }})\r\n    data: Map<string, { url: string; contour: boolean, icon: string | undefined, description: string | undefined, dataSource:DataSource | undefined, colorize: string | undefined   }> = new Map();\r\n\r\n    @property({type: String}) forestCover = \"\";\r\n    @property({type: String}) areaForestCover = \"\";\r\n\r\n\r\n\r\n    private _viewer: Viewer | undefined;\r\n\r\n    constructor() {\r\n        super();\r\n        this.attachShadow({ mode: 'open' });\r\n    }\r\n\r\n    override render() {\r\n        return html`\r\n      ${this.loading ? html`<div id=\"loadingScreen\">Loading...</div>` : null}\r\n      <div id=\"cesiumContainer\">\r\n      </div>\r\n      \r\n      <div id=\"dataContainer\">\r\n          <p class=\"dataTitle\">Total forest coverage</p>\r\n          <div class=\"dataSurface\">\r\n              <div class=\"single-chart\">\r\n                  <svg viewBox=\"0 0 36 36\" class=\"circular-chart green\">\r\n                      <path class=\"circle-bg\"\r\n                            d=\"M18 2.0845\r\n          a 15.9155 15.9155 0 0 1 0 31.831\r\n          a 15.9155 15.9155 0 0 1 0 -31.831\"\r\n                      />\r\n                      <path class=\"circle ${this.loading ? '' : 'circle-animate'}\"\r\n                            stroke-dasharray=\"64.4, 100\"\r\n                            :style=\"circleStyle\"\r\n                            d=\"M18 2.0845\r\n          a 15.9155 15.9155 0 0 1 0 31.831\r\n          a 15.9155 15.9155 0 0 1 0 -31.831\"\r\n                      />\r\n                      <text x=\"18\" y=\"20.35\" class=\"percentage\">${this.forestCover}</text>\r\n                  </svg>\r\n              </div>\r\n          </div>\r\n          <p class=\"dataTitle\">${this.areaForestCover} km2</p>\r\n      </div>\r\n      \r\n      <div id=\"buttonContainer\">\r\n          <h2 class=\"groupTitle\">Layers</h2>\r\n          ${Array.from(this.tilesetUrl.entries()).map(\r\n                  ([key, value]) => html`\r\n                      <button\r\n                              class=\"toggleButton\"\r\n                              @click=\"${() => this.toggleTilesetVisibility(key)}\"\r\n                      >\r\n                          <div class=\"buttonContent\">\r\n                          ${value.icon ? html`<img class=\"icon\" src=\"${value.icon}\" alt=\"Icon for ${key}\" width=\"25\" height=\"25\">` : ''}\r\n                          ${value.description ? html`<span class=\"buttonDescription\">${value.description}</span>` : ''}\r\n                          </div>    \r\n                      </button>\r\n                  `\r\n          )}\r\n          \r\n          <h2 class=\"groupTitle\">Data</h2>\r\n          ${Array.from(this.data.entries()).map(\r\n                  ([key, value]) => html`\r\n              <button\r\n              class=\"toggleButton\"\r\n              @click=\"${() => this.toggleDataVisibility(key)}\"\r\n            >\r\n                <div class=\"buttonContent\">\r\n                ${value.icon ? html`<img class=\"icon\" src=\"${value.icon}\" alt=\"Icon for ${key}\" width=\"25\" height=\"25\">` : ''}\r\n                ${value.description ? html`<span class=\"buttonDescription\">${value.description}</span>` : ''}\r\n                </div>\r\n            </button>\r\n          `\r\n          )}\r\n      </div>\r\n    `;\r\n    }\r\n\r\n\r\n    toggleDataVisibility(key: string) {\r\n        const data  = this.data.get(key);\r\n        console.log(\"key is \" + key)\r\n        if (data && data.dataSource) {\r\n            data.dataSource.show = !data.dataSource.show;\r\n            if (key === 'zone') {\r\n                const legend = this.shadowRoot.querySelector('#legend');\r\n                if(legend){\r\n                    // Se la dataSource è visibile, mostra la legenda, altrimenti nascondila\r\n                    legend.style.display = data.dataSource.show ? 'block' : 'none';\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    toggleTilesetVisibility(key: string) {\r\n        const tilesetInfo = this.tilesetUrl.get(key);\r\n        console.log(tilesetInfo)\r\n        if (tilesetInfo && tilesetInfo.tileset) {\r\n            tilesetInfo.tileset.show = !tilesetInfo.tileset.show;\r\n        }\r\n    }\r\n\r\n    createLegend() {\r\n        // Create a legend element\r\n        const legendElement = document.createElement('div');\r\n        legendElement.id = 'legend';\r\n\r\n        if(this.shadowRoot){\r\n            this.shadowRoot.appendChild(legendElement);  // Append to shadowRoot instead of document.body\r\n        }\r\n        // Populate the legend with color-information\r\n        legend.forEach((color, property) => {\r\n            const item = document.createElement('div');\r\n            item.className = \"legend-container\"\r\n\r\n            const key = document.createElement('div');\r\n            key.className = 'legend-key';\r\n            key.style.backgroundColor = color.toCssColorString();\r\n            key.style.display = 'inline-block';\r\n            key.style.width = '20px';\r\n            key.style.height = '20px';\r\n\r\n            const value = document.createElement('p');\r\n            value.className = \"legend-value\"\r\n            value.innerHTML = property;\r\n\r\n            item.appendChild(key);\r\n            item.appendChild(value);\r\n            legendElement.appendChild(item);\r\n        });\r\n    }\r\n\r\n\r\n    override async updated(changedProperties: Map<string, unknown>) {\r\n        if (changedProperties.has('data') && this.data.size > 0) {\r\n            const dataPromises = Array.from(this.data.entries()).map(async ([_, value]) => {\r\n                const dataSource = await addData(this._viewer, value.url, value.contour, value.colorize);\r\n                await zoomToDataSource(this._viewer, dataSource);\r\n                value.dataSource = dataSource;\r\n                // Create the legend\r\n            });\r\n\r\n            await Promise.all(dataPromises);\r\n            this.createLegend();\r\n            this.loading = false;\r\n        }\r\n\r\n        if (changedProperties.has('tilesetUrl') && this.tilesetUrl.size > 0) {\r\n            const tilesetPromises = Array.from(this.tilesetUrl.entries()).map(async ([_, value]) => {\r\n                if (this._viewer) {\r\n                    value.tileset = addTileset(this._viewer, value.url);\r\n                }\r\n            });\r\n            await Promise.all(tilesetPromises);\r\n        }\r\n\r\n    }\r\n\r\n    override async firstUpdated(_changedProperties: Map<string, unknown>) {\r\n        super.firstUpdated(_changedProperties);\r\n        this._viewer = createCesiumViewer(\r\n            this.shadowRoot!.getElementById(\"cesiumContainer\")!,\r\n            this.cesiumBaseURL,\r\n            this.dataTerrain,\r\n        );\r\n\r\n        this.forestCover = await apiService.getData(\"percentage\", 'forest');\r\n        this.areaForestCover = await apiService.getData(\"area\", 'forest');\r\n    }\r\n\r\n}\r\n\r\ndeclare global {\r\n    interface HTMLElementTagNameMap {\r\n        'map-viewer': MapViewer;\r\n    }\r\n}\r\n"]}